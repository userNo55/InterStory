import React, { useState, useEffect } from 'react';
import { createClient } from '@supabase/supabase-js';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';

// Supabase configuration - replace with your actual project URL and API key
const supabaseUrl = process.env.https://adikbynxabweptbqkktd.supabase.co;
const supabaseAnonKey = process.env.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkaWtieW54YWJ3ZXB0YnFra3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI5OTQ5NjcsImV4cCI6MjA0ODU3MDk2N30.gFlrUoJRnv_OjLYy_kBGgRYeBf-aK_TuZ5JtRkTNiP8;

// Create Supabase client
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const InteractiveStories = () => {
  const [activeStories, setActiveStories] = useState([]);
  const [writtenStories, setWrittenStories] = useState([]);
  const [followingStories, setFollowingStories] = useState([]);
  const [currentTab, setCurrentTab] = useState('active');
  const [searchModalOpen, setSearchModalOpen] = useState(false);
  const [searchParams, setSearchParams] = useState({
    keywords: '',
    storyLength: 'All Sizes',
    ageRating: 'All Age Ratings'
  });

  // Fetch stories based on different categories
  const fetchStories = async () => {
    try {
      // Active Stories (with time remaining)
      const { data: activeData, error: activeError } = await supabase
        .from('story')
        .select('*')
        .eq('status', 'active')
        .order('created_at', { ascending: false });

      // Written Stories (completed or archived)
      const { data: writtenData, error: writtenError } = await supabase
        .from('story')
        .select('*')
        .eq('status', 'completed')
        .order('created_at', { ascending: false });

      // Following Stories (based on user's follows)
      const { data: followingData, error: followingError } = await supabase
        .from('story')
        .select('*')
        .in('id', await getFollowedStoryIds())
        .order('created_at', { ascending: false });

      if (activeError) console.error('Active Stories Error:', activeError);
      if (writtenError) console.error('Written Stories Error:', writtenError);
      if (followingError) console.error('Following Stories Error:', followingError);

      setActiveStories(activeData || []);
      setWrittenStories(writtenData || []);
      setFollowingStories(followingData || []);
    } catch (error) {
      console.error('Story Fetch Error:', error);
    }
  };

  // Get story IDs that the user follows
  const getFollowedStoryIds = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return [];

    const { data: followData, error } = await supabase
      .from('user_story_follows')
      .select('story_id')
      .eq('user_id', user.id);

    if (error) {
      console.error('Follow Fetch Error:', error);
      return [];
    }

    return followData.map(follow => follow.story_id);
  };

  // Real-time subscription to story updates
  useEffect(() => {
    fetchStories();

    // Set up real-time subscription
    const storySubscription = supabase
      .channel('public:story')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'story' },
        () => fetchStories()
      )
      .subscribe();

    // Cleanup subscription on component unmount
    return () => {
      supabase.removeChannel(storySubscription);
    };
  }, []);

  // Search functionality
  const handleSearch = async (e) => {
    e.preventDefault();
    const { keywords, storyLength, ageRating } = searchParams;

    let query = supabase.from('story').select('*');

    // Apply filters
    if (keywords) {
      query = query.or(`title.ilike.%${keywords}%,description.ilike.%${keywords}%`);
    }

    if (storyLength !== 'All Sizes') {
      // Assuming you have a 'story_length' column in your stories table
      query = query.eq('story_length', storyLength.toLowerCase());
    }

    if (ageRating !== 'All Age Ratings') {
      query = query.eq('age_rating', ageRating);
    }

    const { data, error } = await query;

    if (error) {
      console.error('Search Error:', error);
      return;
    }

    // You might want to set a specific state for search results
    setActiveStories(data);
    setSearchModalOpen(false);
  };

  // Render story cards
  const renderStoryCards = (stories) => (
    <div className="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
      {stories.map(story => (
        <Card 
          key={story.id} 
          className="hover:scale-105 transition-transform cursor-pointer"
          onClick={() => window.location.href = `/story/${story.id}`}
        >
          <CardHeader>
            <CardTitle>{story.title}</CardTitle>
          </CardHeader>
          <CardContent>
            <p>Author: {story.author_name}</p>
            {story.time_remaining && (
              <p className="text-primary">
                Time remaining: {story.time_remaining}
              </p>
            )}
            <p>Readers: {story.reader_count || 0}</p>
          </CardContent>
        </Card>
      ))}
    </div>
  );

  return (
    <div className="container mx-auto p-4">
      <Tabs 
        value={currentTab} 
        onValueChange={setCurrentTab}
        className="w-full"
      >
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="active">Active</TabsTrigger>
          <TabsTrigger value="written">Written</TabsTrigger>
          <TabsTrigger value="followings">Followings</TabsTrigger>
        </TabsList>
        
        <TabsContent value="active">
          {renderStoryCards(activeStories)}
        </TabsContent>
        
        <TabsContent value="written">
          {renderStoryCards(writtenStories)}
        </TabsContent>
        
        <TabsContent value="followings">
          {renderStoryCards(followingStories)}
        </TabsContent>
      </Tabs>

      {/* Search Modal */}
      {searchModalOpen && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center">
          <div className="bg-background p-6 rounded-lg w-full max-w-md">
            <h2 className="text-2xl mb-4">Search Stories</h2>
            <form onSubmit={handleSearch} className="space-y-4">
              <input
                type="text"
                placeholder="Keywords"
                value={searchParams.keywords}
                onChange={(e) => setSearchParams(prev => ({
                  ...prev, 
                  keywords: e.target.value
                }))}
                className="w-full p-2 border rounded"
              />
              <select
                value={searchParams.storyLength}
                onChange={(e) => setSearchParams(prev => ({
                  ...prev, 
                  storyLength: e.target.value
                }))}
                className="w-full p-2 border rounded"
              >
                <option>All Sizes</option>
                <option>Short Stories</option>
                <option>Medium Length</option>
                <option>Long Stories</option>
              </select>
              <select
                value={searchParams.ageRating}
                onChange={(e) => setSearchParams(prev => ({
                  ...prev, 
                  ageRating: e.target.value
                }))}
                className="w-full p-2 border rounded"
              >
                <option>All Age Ratings</option>
                <option>12+</option>
                <option>16+</option>
                <option>18+</option>
              </select>
              <button 
                type="submit" 
                className="w-full p-2 bg-primary text-white rounded"
              >
                Search
              </button>
            </form>
            <button 
              onClick={() => setSearchModalOpen(false)}
              className="w-full mt-2 p-2 bg-secondary text-white rounded"
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Search Button */}
      <button 
        onClick={() => setSearchModalOpen(true)}
        className="fixed top-4 right-20 bg-primary text-white p-2 rounded-full"
      >
        üîç Search
      </button>
    </div>
  );
};

export default InteractiveStories;
